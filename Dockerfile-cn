# 采用官方镜像作为基础
# scipy-notebook 包含了常用的科学计算包，如果不需要可以换成 jupyter/base-notebook
FROM quay.io/jupyter/scipy-notebook:latest

# ------------------------------------------------------------
# 阶段 1：以 root 身份安装系统依赖和 Python 扩展包
# ------------------------------------------------------------
USER root

# [可选] 如果您有其他需要 apt 安装的系统工具，可以放在这里
# RUN apt-get update && apt-get install -y ...

# 使用 pip 并通过国内 pypi 镜像一次性安装所有 JupyterHub 相关的 Python 扩展
RUN pip install --no-cache-dir -i https://pypi.tuna.tsinghua.edu.cn/simple \
    dockerspawner \
    docker \
    oauthenticator \
    jupyterlab-language-pack-zh-CN \
    jupyterlab-lsp \
    jedi-language-server

# 设置时区
ENV TZ=Asia/Shanghai
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone

# [重要] 确保 jovyan 用户对其主目录拥有完全所有权
# 这一步可以防止因 root 操作可能导致的权限问题
RUN chown -R jovyan:users /home/jovyan/

# ------------------------------------------------------------
# 阶段 2：切回 jovyan 用户
# ------------------------------------------------------------
USER jovyan

# 工作目录保持官方默认
WORKDIR /home/jovyan

# 元数据标签
LABEL maintainer="Feature"
LABEL description="JupyterLab with extensions for JupyterHub (dockerspawner, oauthenticator)"
