# 采用官方镜像作为基础
FROM quay.io/jupyter/scipy-notebook:latest

# ------------------------------------------------------------
# 阶段 1：以 root 身份安装系统依赖
# ------------------------------------------------------------
USER root

# 安装构建 Rust / evcxr / uv 所需的系统包
RUN apt-get update && \
    apt-get install -y \
        build-essential \
        cmake \
        pkg-config \
        libssl-dev \
        curl \
        iputils-ping \
        net-tools \
        dnsutils \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# ------------------------------------------------------------
# 阶段 2：配置国内镜像并安装 Rust 工具链
# ------------------------------------------------------------

# 设置安装路径
ENV RUSTUP_HOME=/opt/rust
ENV CARGO_HOME=/opt/rust
ENV UV_INSTALL_DIR=/opt/rust/bin
ENV PATH="/opt/rust/bin:${PATH}"

# 为 cargo (Rust包管理器) 配置清华大学镜像源
RUN mkdir -p ${CARGO_HOME} && \
    echo '[source.crates-io]' >> ${CARGO_HOME}/config.toml && \
    echo 'replace-with = "tuna"' >> ${CARGO_HOME}/config.toml && \
    echo '[source.tuna]' >> ${CARGO_HOME}/config.toml && \
    echo 'registry = "https://mirrors.tuna.tsinghua.edu.cn/git/crates.io-index.git"' >> ${CARGO_HOME}/config.toml

# --- [核心修正] ---
# 将环境变量直接注入到 RUN 命令中，确保 rustup-init 脚本能读取到
# 同时删除了之前单独设置的 ENV RUSTUP_DIST_SERVER 和 ENV RUSTUP_UPDATE_ROOT
RUN RUSTUP_DIST_SERVER=https://mirrors.tuna.tsinghua.edu.cn/rustup \
    RUSTUP_UPDATE_ROOT=https://mirrors.tuna.tsinghua.edu.cn/rustup/rustup \
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y \
    && curl -LsSf https://astral.sh/uv/install.sh | sh \
    && rustc --version \
    && cargo --version \
    && uv --version

# 使用配置好的 cargo 镜像安装 evcxr_jupyter
RUN cargo install evcxr_jupyter && \
    evcxr_jupyter --install && \
    mkdir -p /opt/conda/share/jupyter/kernels && \
    mv /home/jovyan/.local/share/jupyter/kernels/rust /opt/conda/share/jupyter/kernels/rust && \
    chown -R jovyan:users /opt/conda/share/jupyter/kernels/rust && \
    rm -rf /home/jovyan/.local

# 将 /home/jovyan 目录的所有权完全交还给 jovyan 用户
RUN chown -R jovyan:users /home/jovyan/

# ------------------------------------------------------------
# 阶段 3：切回 jovyan 用户并安装 Python 包
# ------------------------------------------------------------
USER jovyan

# 设置环境变量为 jovyan 用户
RUN echo 'source /opt/rust/env 2>/dev/null || true' >> ~/.bashrc

# 用 uv 并通过国内 pypi 镜像安装 Python 扩展
RUN uv pip install --system --no-cache-dir -i https://pypi.tuna.tsinghua.edu.cn/simple \
        jupyterlab-language-pack-zh-CN \
        jupyterlab-lsp \
        jedi-language-server

# 工作目录保持官方默认
WORKDIR /home/jovyan

# 元数据标签
LABEL maintainer="Feature"
LABEL description="JupyterLab with Rust kernel, installed system-wide for multi-user environments (e.g., JupyterHub)"
